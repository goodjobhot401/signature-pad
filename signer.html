<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Viewer</title>

  <!-- bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <style>
    body {
      width: 1280px;
      margin: 0 auto;
    }
  </style>
  <!-- Fabric.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.js"
    integrity="sha512-hOJ0mwaJavqi11j0XoBN1PtOJ3ykPdP6lp9n29WVVVVZxgx9LO7kMwyyhaznGJ+kbZrDN1jFZMt2G9bxkOHWFQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
  <div class="container">
    <div class="row">
      <!-- 左半邊 -->
      <div id="left-side" class="col col-4 border pt-5 pb-5" style="height: 100vh; background-color: #333333c4">

        <div class="only-for-layout" style="height: 10%; z-index: -1;"></div>

        <h1 class="mt-5 text-center text-light">創建簽名</h1>
        <canvas id="canvas-sign" class="mt-3 border" style="width: 100%; background-color: #f0f0f0"></canvas>

        <div class="mt-3 mb-5 d-flex justify-content-evenly" style="height: 50px; width: 100%;">
          <button id="clean" class="btn btn-primary fs-4" style="width: 100px;">Clean</button>
          <button id="undo" class="btn btn-warning fs-4" style="width: 100px;">Undo</button>
          <button id="save" class="btn btn-success fs-4" style="width: 100px;">Save</button>
        </div>

        <h1 class="mt-5 mb-5 text-center text-light">簽名檔</h1>
        <div id="signature-img-zone" class="border" style="height: 200px; width: 100%; background-color: #f0f0f0"></div>
        <div class=" mt-3 mb-5 d-flex flex-row justify-content-evenly" style="width: 100%;">
          <button id="clean-img" class="btn btn-primary fs-4" style="width: 100px;">Clean</button>
          <button id="sign-pdf" class="btn btn-warning fs-4" style="width: 100px;">Sign</button>
          <button id="submit-sign" class="btn btn-success fs-4" style="width: 100px;">Submit</button>
        </div>

        <div class="only-for-layout" style="height: 10%; z-index: -1;"></div>

        <div class="d-flex justify-content-evenly">
          <button id="export-pdf" class="btn btn-success fs-4" style="width: 150px;">Export</button>
          <button id="export-pdf-backend" class="btn btn-danger fs-4" style="width: 150px;">Export BE</button>
        </div>
      </div>

      <!-- 右半邊 -->
      <div id="right-side" class="col col-8 border"
        style="height: 100vh; overflow-y: scroll; background-color: #f0f0f0;">

        <div id="container" style="position: relative;">
          <div id="canvas-pdf-container" style="position: absolute; top: 0; left: 0; display: block;">
            <canvas id="canvas-pdf"></canvas>
          </div>

          <div id="fabric-canvas-container" style="position: absolute; top: 0; left: 0;">
            <canvas id="fabric-canvas"></canvas>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- 引入 pdf.js -->
  <script src=" .//build/pdf.js"></script>
  <!-- 引入 signature-pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <!-- 引入 jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"
    integrity="sha512-1g3IT1FdbHZKcBVZzlk4a4m5zLRuBjMFMxub1FeIRvR+rhfqHFld9VFXXBYe66ldBWf+syHHxoZEbZyunH6Idg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>


  <script>
    // 右半邊 PDF 區
    // 宣告 pdf 檔案的位置, 要渲染的頁數, 要縮放的大小
    const url = './resume.pdf'
    const pageNumber = 1
    const scale = 1.5
    let fabricCanvas;
    let signRect;
    let signRects = []

    // 左半簽名區
    const canvas = document.getElementById("canvas-sign")
    const signaturePad = new SignaturePad(canvas)
    const cleanBut = document.getElementById('clean')
    const undoBut = document.getElementById('undo')
    const saveBut = document.getElementById('save')
    const signatureZone = document.getElementById('signature-img-zone')
    const cleanImg = document.getElementById('clean-img')
    const signBut = document.getElementById('sign-pdf')
    const submitBut = document.getElementById('submit-sign')
    const exportBut = document.getElementById('export-pdf')
    const exportButBE = document.getElementById('export-pdf-backend')

    let savedStroke = []
    // 在簽名版設置監聽器
    signaturePad.addEventListener("beginStroke", () => {
      console.log('signature begin!')
    }, { once: true })

    // 每完成一筆畫, pad 的畫面轉成 base64 並存進 savedStroke
    signaturePad.addEventListener("endStroke", () => {
      const pngData = signaturePad.toDataURL()
      savedStroke.push(pngData)
    })

    // 移除 savedStroke 最新的資料, 重新 render, 實現 undo 功能 
    undoBut.addEventListener('click', () => {
      if (savedStroke.length > 0) {
        savedStroke.pop()
        signaturePad.clear()
        signaturePad.fromDataURL(savedStroke.at(-1))
      }
    })

    // 清除畫面和 savedStroke 的資料
    cleanBut.addEventListener('click', () => {
      signaturePad.clear()
      savedStroke = []
    })

    // 將簽名版轉成 png 印到去背版
    saveBut.addEventListener("click", () => {
      if (savedStroke.length > 0) {
        const currentData = savedStroke.at(-1)
        const signatureZone = document.getElementById('signature-img-zone')

        // 去背板一次只能出現一個 png
        while (signatureZone.firstChild) {
          signatureZone.removeChild(signatureZone.firstChild)
        }

        const newPng = document.createElement('img')
        newPng.style.width = signatureZone.clientWidth + 'px'
        newPng.style.height = signatureZone.clientHeight + 'px'
        newPng.classList.add('signature-img')
        newPng.setAttribute('src', currentData)
        signatureZone.appendChild(newPng)
      }
    })

    // 清空簽名檔
    cleanImg.addEventListener('click', () => {
      const signatureZone = document.getElementById('signature-img-zone')
      signatureZone.removeChild(signatureZone.firstChild)
    })

    // 簽名檔帶入簽名框, 消除簽名框
    signBut.addEventListener('click', () => {
      if (signatureZone.firstChild) {
        const image = signatureZone.firstChild
        const pdfCanvas = document.getElementById('canvas-pdf-container')

        // 篩選 signRectInfo 中的對象
        const filteredSignRects = signRectInfo.filter(signRect => signRect.name === name)

        filteredSignRects.forEach(function (signRect) {
          const signImageCanvas = document.createElement('canvas')
          signImageCanvas.width = signRect.width
          signImageCanvas.height = signRect.height
          signImageCanvas.style.position = 'absolute'
          signImageCanvas.style.top = `${signRect.top}px`
          signImageCanvas.style.left = `${signRect.left}px`
          signImageCanvas.classList = 'sign-image-canvas'

          const context = signImageCanvas.getContext('2d')
          const newImage = new Image()
          newImage.src = image.src

          newImage.onload = () => {
            context.drawImage(newImage, 0, 0, signRect.width, signRect.height)
          }
          pdfCanvas.appendChild(signImageCanvas)
        })

        const newSignRects = signRects
        newSignRects.forEach(function (signRect) {
          fabricCanvas.remove(signRect)
        })
        fabricCanvas.renderAll()
      }
    })

    // 按 delete 刪除創建的 canvas 元件
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Delete' || event.key === 'Backspace') {
        const activeObject = fabricCanvas.getActiveObject()
        if (activeObject.type === 'image' || activeObject.type === 'rect') {
          const deletedSignRect = signRects.find((rect) => rect === activeObject)
          if (deletedSignRect) {
            const index = signRects.indexOf(deletedSignRect)
            if (index > -1) {
              signRects.splice(index, 1)
            }
          }
          fabricCanvas.remove(activeObject)
          fabricCanvas.discardActiveObject()
          fabricCanvas.renderAll()
        } else {
          console.log("This object's type = " + activeObject.type)
        }
      }
    })

    // submit 將畫面中的簽名檔轉成編碼傳至後端
    submitBut.addEventListener('click', () => {
      if (signatureZone.firstChild) {
        const currentData = savedStroke.at(-1)
        console.log(`The signature's base64 code is:` + currentData)
      }
    })

    // 匯出 PDF (當前畫面)
    exportBut.addEventListener('click', () => {
      if (signatureZone.firstChild) {
        exportToPDF(url, pageNumber, scale)
      } else {
        console.log('You have to finish sign!')
      }
    })

    // 匯出完整 PDF (後端)
    exportButBE.addEventListener('click', () => {
      exportToPDFFinal(url, pageNumber, scale, signRectList, signImageDataUrlList)
    })

    // 右半 pdf 區, 引入 pdf.worker.js
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      './build/pdf.worker.js'

    // 取得 PDF 的長寬
    async function getPDFViewport(url, pageNumber, scale) {
      return new Promise(async (resolve, reject) => {
        try {
          const pdf = await pdfjsLib.getDocument(url).promise
          const page = await pdf.getPage(pageNumber)
          const viewport = page.getViewport({ scale: scale })

          const width = viewport.width
          const height = viewport.height

          resolve({ width, height })
        } catch (error) {
          reject(error)
        }
      })
    }

    // 將 PDF 渲染成 canvas
    async function renderPDF(url, pageNumber, scale) {
      try {
        // 解析 pdf 檔的第幾頁資料
        const pdf = await pdfjsLib.getDocument(url).promise
        const page = await pdf.getPage(pageNumber)

        const viewport = page.getViewport({ scale: scale })
        const width = viewport.width
        const height = viewport.height

        // 設定 pdf 的 canvas 長寬
        const canvasPDF = document.getElementById('canvas-pdf')
        canvasPDF.width = width
        canvasPDF.height = height

        // 輸入 pdf 解析後的資料
        const context = canvasPDF.getContext('2d')
        const renderContext = {
          canvasContext: context,
          viewport: viewport
        }
        await page.render(renderContext)
      } catch (error) {
        console.log('An error occurred:', error)
      }
    }


    const name = 'jack'
    const signRectInfo = [
      {
        "serialNum": 1,
        "name": "tom",
        "color": "blue",
        "priority": "1",
        "left": 21.038728202255058,
        "top": 22.33118875581509,
        "width": 190.79613348959208,
        "height": 95.39806674479604
      },
      {
        "serialNum": 2,
        "name": "tom",
        "color": "blue",
        "priority": "1",
        "left": 334.50202145302853,
        "top": 992.6718563140835,
        "width": 466.74508895963936,
        "height": 233.37254447981968
      },
      {
        "serialNum": 3,
        "name": "jack",
        "color": "red",
        "priority": "2",
        "left": 602.0491738750688,
        "top": 553.2910899267961,
        "width": 198.0944192308449,
        "height": 99.04720961542245
      },
      {
        "serialNum": 4,
        "name": "jack",
        "color": "red",
        "priority": "2",
        "left": 149.9754884795854,
        "top": 576.9466495100464,
        "width": 300,
        "height": 150
      }
    ]

    const signImageDataUrl = [{
      "name": "tom",
      "dataUrl": "data:image/png;base64,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"
    }, {
      "name": "jack",
      "dataUrl": "data:image/png;base64,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"
    }]

    // 依照 PDF 的長寬創建 fabric 舞台, 並依照 name 繪製簽名框
    async function createFabricCanvas(url, pageNumber, scale, name) {
      try {
        const { width, height } = await getPDFViewport(url, pageNumber, scale)
        const fabricCanvasContainer = document.getElementById('fabric-canvas-container')
        fabricCanvasContainer.style.width = `${width}px`
        fabricCanvasContainer.style.height = `${height}px`

        fabricCanvas = new fabric.Canvas('fabric-canvas', {
          width: width,
          height: height
        })

        for (const item of signRectInfo) {
          if (item.name === name) {
            const rect = document.createElement('canvas')
            const signRect = new fabric.Rect(rect)

            signRect.set({
              left: item.left,
              top: item.top,
              width: item.width,
              height: item.height,
              fill: item.color,
              opacity: 0.35,
              lockMovementX: true,
              lockMovementY: true,
              selectable: false,
            })
            signRects.push(signRect)
            fabricCanvas.add(signRect)
          }
        }
        return fabricCanvas
      } catch (error) {
        console.log('An error occurred:', error)
        return null;
      }
    }


    // 匯出 PDF 檔 (client)
    async function exportToPDF(url, pageNumber, scale) {
      try {
        const { width, height } = await getPDFViewport(url, pageNumber, scale)

        // 創建合併所有 canvas 元素的 canvas
        const mergedCanvas = document.createElement('canvas')
        mergedCanvas.width = width
        mergedCanvas.height = height
        const mergedContext = mergedCanvas.getContext('2d')

        const canvasPDF = document.getElementById('canvas-pdf')
        const otherCanvasElements = document.querySelectorAll('.sign-image-canvas')

        const loadCanvasImages = async () => {
          mergedContext.drawImage(canvasPDF, 0, 0)
          // 繪製其他 canvas 元素
          for (const canvasElement of otherCanvasElements) {
            const parentElementRect = canvasElement.parentElement.getBoundingClientRect()
            const canvasRect = canvasElement.getBoundingClientRect()
            const left = canvasRect.left - parentElementRect.left
            const top = canvasRect.top - parentElementRect.top

            await new Promise((resolve) => {
              const img = new Image()
              img.onload = () => {
                mergedContext.drawImage(canvasElement, left, top)
                resolve()
              }
              const signDataUrl = canvasElement.toDataURL('image/jpeg')
              console.log(signDataUrl)
              img.src = signDataUrl
            })
          }

          //  合併後的 canvas 輸出 PDF
          const newPDF = new jsPDF('portrait', 'px', [width, height])
          const dataUrl = mergedCanvas.toDataURL('image/jpeg')

          if (dataUrl) {
            newPDF.addImage(dataUrl, 'JPEG', 0, 0, width, height)
            newPDF.save('testPDF')
          }
        }
        await loadCanvasImages()
      } catch (error) {
        console.log('An error occurred', error)
      }
    }

    let signRectList = signRectInfo
    let signImageDataUrlList = signImageDataUrl

    // 匯出 PDF 檔 (server)
    async function exportToPDFFinal(url, pageNumber, scale, signRectList, signImageDataUrlList) {
      try {
        // 創造 fabric 舞台和簽名框
        const { width, height } = await getPDFViewport(url, pageNumber, scale)
        const fabricCanvasContainer = document.getElementById('fabric-canvas-container')
        fabricCanvasContainer.style.width = `${width}px`
        fabricCanvasContainer.style.height = `${height}px`
        fabricCanvas = new fabric.Canvas('fabric-canvas', {
          width: width,
          height: height
        })

        let signRectsList = []
        for (const item of signRectList) {
          const rect = document.createElement('canvas')
          const signRect = new fabric.Rect(rect)

          signRect.set({
            name: item.name,
            left: item.left,
            top: item.top,
            width: item.width,
            height: item.height,
            fill: item.color,
            opacity: 0.35,
            lockMovementX: true,
            lockMovementY: true,
            selectable: false,
          })
          signRectsList.push(signRect)
          fabricCanvas.add(signRect)
        }


        const pdfCanvas = document.getElementById('canvas-pdf-container')
        // 每一個 signRect 都填滿對應的 dataUrl, 並移除自己的 signRectsList 的紀錄
        signRectsList.forEach(function (item) {
          const filteredSignImageDataUrl = signImageDataUrlList.filter(signRect => signRect.name === item.name)
          const signImageCanvas = document.createElement('canvas')
          signImageCanvas.width = item.width
          signImageCanvas.height = item.height
          signImageCanvas.style.position = 'absolute'
          signImageCanvas.style.top = `${item.top}px`
          signImageCanvas.style.left = `${item.left}px`
          signImageCanvas.classList = 'sign-image-canvas'

          const context = signImageCanvas.getContext('2d')
          const newImage = new Image()
          console.log(filteredSignImageDataUrl)
          newImage.src = filteredSignImageDataUrl[0].dataUrl

          newImage.onload = () => {
            context.drawImage(newImage, 0, 0, item.width, item.height)
          }
          pdfCanvas.appendChild(signImageCanvas)
        })
        const newSignRects = signRectsList
        newSignRects.forEach(function (signRect) {
          fabricCanvas.remove(signRect)
        })
        fabricCanvas.renderAll()

        // 創建合併所有 canvas 元素的 canvas
        const mergedCanvas = document.createElement('canvas')
        mergedCanvas.width = width
        mergedCanvas.height = height
        const mergedContext = mergedCanvas.getContext('2d')

        const canvasPDF = document.getElementById('canvas-pdf')
        const otherCanvasElements = document.querySelectorAll('.sign-image-canvas')

        // 合併所有 canvas 並輸出成 PDF
        const loadCanvasImages = async () => {
          mergedContext.drawImage(canvasPDF, 0, 0)

          for (const canvasElement of otherCanvasElements) {
            const parentElementRect = canvasElement.parentElement.getBoundingClientRect()
            const canvasRect = canvasElement.getBoundingClientRect()
            const left = canvasRect.left - parentElementRect.left
            const top = canvasRect.top - parentElementRect.top

            await new Promise((resolve) => {
              const img = new Image()
              img.onload = () => {
                mergedContext.drawImage(canvasElement, left, top)
                resolve()
              }
              const signDataUrl = canvasElement.toDataURL('image/jpeg')
              img.src = signDataUrl
            })
          }
          const newPDF = new jsPDF('portrait', 'px', [width, height])
          const dataUrl = mergedCanvas.toDataURL('image/jpeg')

          if (dataUrl) {
            newPDF.addImage(dataUrl, 'JPEG', 0, 0, width, height)
            newPDF.save('testPDF')
          }
        }
        await loadCanvasImages()

      } catch (error) {
        console.log('An error occurred', error)
      }
    }

    renderPDF(url, pageNumber, scale)
    createFabricCanvas(url, pageNumber, scale, name)

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>
</body>

</html>