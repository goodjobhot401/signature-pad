<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Viewer</title>

  <!-- bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <style>
    body {
      width: 1280px;
      margin: 0 auto;
    }
  </style>
  <!-- Fabric.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.js"
    integrity="sha512-hOJ0mwaJavqi11j0XoBN1PtOJ3ykPdP6lp9n29WVVVVZxgx9LO7kMwyyhaznGJ+kbZrDN1jFZMt2G9bxkOHWFQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
  <div class="container">
    <div class="row">
      <!-- 左半邊 -->
      <div id="left-side" class="col col-4 d-flex flex-column justify-content-center border pt-5 pb-5"
        style="height: 100vh; background-color: #333333c4">

        <div>
          <h1 class="text-center text-light">建立簽名框</h1>

          <label class="form-label" style="color: #f0f0f0;">指定簽名對象</label>
          <input id="signer-name" class="mb-3 form-control">

          <label class="form-label" style="color: #f0f0f0;">指定簽名順位</label>
          <select id="signer-priority" class="mb-3 form-select">
            <option selected>choose the priority</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>


          <label class="form-label" style="color: #f0f0f0;">選取簽名框顏色</label>
          <select id="signer-color" class="mb-3 form-select">
            <option selected>choose one color</option>
            <option value="blue">blue</option>
            <option value="red">red</option>
            <option value="yellow">yellow</option>
          </select>

          <div class="mb-4 d-flex justify-content-center">
            <button id="signer-lock" class="btn btn-warning" disabled>確定</button>
          </div>

          <div class="only-for-layout" style="height: 20%;"></div>

          <div class="mt-5 mb-4 d-flex justify-content-evenly">
            <button id="create-rect" class="btn btn-primary fs-4" style="width: 30%; height: 50px;"
              disabled>Create</button>
            <button id="rect-lock" class="btn btn-warning fs-4" style="width: 30%; height: 50px;">Lock</button>
            <button id="submit" class="btn btn-success fs-4" style="width: 30%; height: 50px;" disabled>Submit</button>
          </div>
        </div>

        <div class="only-for-layout" style="height: 30%; z-index: -1;"></div>

      </div>

      <!-- 右半邊 -->
      <div id="right-side" class="col col-8 border"
        style="height: 100vh; overflow-y: scroll; background-color: #f0f0f0;">

        <div id="container" style="position: relative;">
          <div id="canvas-pdf-container" style="position: absolute; top: 0; left: 0; display: block;">
            <canvas id="canvas-pdf"></canvas>
          </div>

          <div id="fabric-canvas-container" style="position: absolute; top: 0; left: 0;">
            <canvas id="fabric-canvas"></canvas>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- 引入 pdf.js -->
  <script src=" .//build/pdf.js"></script>
  <!-- 引入 signature-pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <!-- 引入 jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"
    integrity="sha512-1g3IT1FdbHZKcBVZzlk4a4m5zLRuBjMFMxub1FeIRvR+rhfqHFld9VFXXBYe66ldBWf+syHHxoZEbZyunH6Idg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>


  <script>
    // 右半邊 PDF 區
    // 宣告 pdf 檔案的位置, 要渲染的頁數, 要縮放的大小
    const url = './resume.pdf'
    const pageNumber = 1
    const scale = 1.5
    let fabricCanvas;
    let signRect;
    let signRects = []
    let signRectInfo = []
    let serialNum = 1
    let isDraggingEnabled = true
    let signImageCanvasList = []

    // 左半簽名區
    const canvas = document.getElementById("canvas-sign")
    const signerNameInput = document.getElementById('signer-name')
    const signerPrioritySelect = document.getElementById('signer-priority')
    const signerColorSelect = document.getElementById('signer-color')
    const signerLockButton = document.getElementById('signer-lock')
    const createRectBut = document.getElementById('create-rect')
    const lockBut = document.getElementById('rect-lock')
    const submitBut = document.getElementById('submit')

    //「指定對象」「指定順位」「簽名框顏色」都有選取才能按確定
    function toggleSignerLockButton() {
      const nameValue = signerNameInput.value.trim()
      const priorityValue = signerPrioritySelect.value;
      const colorValue = signerColorSelect.value;

      if (nameValue && priorityValue !== 'choose the priority' && colorValue !== 'choose one color') {
        signerLockButton.disabled = false
      } else {
        signerLockButton.disabled = true
      }
    }

    signerNameInput.addEventListener('input', toggleSignerLockButton)
    signerPrioritySelect.addEventListener('change', toggleSignerLockButton)
    signerColorSelect.addEventListener('change', toggleSignerLockButton)


    // 確定鍵按下後 才能創建簽名框
    signerLockButton.addEventListener('click', () => {
      createRectBut.removeAttribute("disabled")
    })

    // 創建指定簽名框
    createRectBut.addEventListener('click', () => {
      const rect = document.createElement('canvas')
      const signRect = new fabric.Rect(rect)
      signRect.name = signerNameInput.value
      signRect.priority = signerPrioritySelect.value
      signRect.color = signerColorSelect.value
      signRect.serialNum = serialNum
      serialNum++

      signRect.set({
        left: 100,
        top: 500,
        opacity: 0.35,
        fill: `${signerColorSelect.value}`,
        lockMovementX: !isDraggingEnabled,
        lockMovementY: !isDraggingEnabled
      })

      signRects.push(signRect)
      fabricCanvas.add(signRect)

      signRect.on('mousedblclick', function () {
        const deletedSignRect = signRects.find((rect) => rect.serialNum === signRect.serialNum)
        const index = signRects.indexOf(deletedSignRect)
        if (index > -1) {
          signRects.splice(index, 1)
        }
        fabricCanvas.remove(signRect)
        fabricCanvas.discardActiveObject()
        fabricCanvas.renderAll()
      })
      fabricCanvas.renderAll()
    })

    // 鎖定簽名框(不能新增簽名框, 不能拖移)
    lockBut.addEventListener('click', () => {
      isDraggingEnabled = !isDraggingEnabled

      signRects.forEach(function (signRect) {
        signRect.lockMovementX = !isDraggingEnabled
        signRect.lockMovementY = !isDraggingEnabled
      })

      if (isDraggingEnabled === false) {
        lockBut.innerText = 'Unlock'
        lockBut.classList.remove('btn-warning')
        lockBut.classList.add('btn-danger')
        submitBut.removeAttribute("disabled")
        createRectBut.setAttribute("disabled", "true")
        signRectInfo = []
      } else {
        lockBut.innerText = 'Lock'
        lockBut.classList.remove('btn-danger')
        lockBut.classList.add('btn-warning')
        submitBut.setAttribute("disabled", "true")
        createRectBut.removeAttribute("disabled")
      }
      fabricCanvas.renderAll()
    })

    // 記錄簽名框的座標, 長寬資料
    submitBut.addEventListener('click', () => {
      signRects.forEach(function (signRect) {
        const scaleX = signRect.scaleX
        const scaleY = signRect.scaleY

        const originalWidth = signRect.width
        const originalHeight = signRect.height

        const scaledWidth = originalWidth * scaleX
        const scaledHeight = originalHeight * scaleY

        const rectInfo = {
          serialNum: signRect.serialNum,
          name: signRect.name,
          color: signRect.color,
          priority: signRect.priority,
          left: signRect.left,
          top: signRect.top,
          width: scaledWidth,
          height: scaledHeight
        }
        signRectInfo.push(rectInfo)
      })
      console.log(signRectInfo)
    })

    // 按 delete 刪除創建的 canvas 元件
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Delete' || event.key === 'Backspace') {
        const activeObject = fabricCanvas.getActiveObject()
        if (activeObject.type === 'image' || activeObject.type === 'rect') {
          const deletedSignRect = signRects.find((rect) => rect === activeObject)
          if (deletedSignRect) {
            const index = signRects.indexOf(deletedSignRect)
            if (index > -1) {
              signRects.splice(index, 1)
            }
          }
          fabricCanvas.remove(activeObject)
          fabricCanvas.discardActiveObject()
          fabricCanvas.renderAll()
        } else {
          console.log("This object's type = " + activeObject.type)
        }
      }
    })

    // 右半 pdf 區, 引入 pdf.worker.js
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      './build/pdf.worker.js'

    // 取得 PDF 的長寬
    async function getPDFViewport(url, pageNumber, scale) {
      return new Promise(async (resolve, reject) => {
        try {
          const pdf = await pdfjsLib.getDocument(url).promise
          const page = await pdf.getPage(pageNumber)
          const viewport = page.getViewport({ scale: scale })

          const width = viewport.width
          const height = viewport.height

          resolve({ width, height })
        } catch (error) {
          reject(error)
        }
      })
    }

    // 將 PDF 渲染成 canvas
    async function renderPDF(url, pageNumber, scale) {
      try {
        // 解析 pdf 檔的第幾頁資料
        const pdf = await pdfjsLib.getDocument(url).promise
        const page = await pdf.getPage(pageNumber)

        const viewport = page.getViewport({ scale: scale })
        const width = viewport.width
        const height = viewport.height

        // 設定 pdf 的 canvas 長寬
        const canvasPDF = document.getElementById('canvas-pdf')
        canvasPDF.width = width
        canvasPDF.height = height

        // 輸入 pdf 解析後的資料
        const context = canvasPDF.getContext('2d')
        const renderContext = {
          canvasContext: context,
          viewport: viewport
        }
        await page.render(renderContext)
      } catch (error) {
        console.log('An error occurred:', error)
      }
    }

    // 依照 PDF 的長寬創建 fabric 舞台
    async function createFabricCanvas(url, pageNumber, scale) {
      try {
        // 獲取 viewport 的長寬
        const { width, height } = await getPDFViewport(url, pageNumber, scale)

        // 設置 fabricCanvasContainer 長寬
        const fabricCanvasContainer = document.getElementById('fabric-canvas-container')
        fabricCanvasContainer.style.width = `${width}px`
        fabricCanvasContainer.style.height = `${height}px`

        // 創建 Fabric 舞台
        fabricCanvas = new fabric.Canvas('fabric-canvas', {
          width: width,
          height: height
        })
        return fabricCanvas
      } catch (error) {
        console.log('An error occurred:', error)
        return null;
      }
    }

    renderPDF(url, pageNumber, scale)
    createFabricCanvas(url, pageNumber, scale)

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>
</body>

</html>